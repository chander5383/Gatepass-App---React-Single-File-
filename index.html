<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GWTPL Gate Pass — Advanced</title>
<style>
  /* -----------------------------
     Basic variables & reset
     ----------------------------- */
  :root{
    --accent:#0b5394;
    --muted:#555;
    --paper-w:210mm;
    --paper-h:297mm;
    --max-width:900px;
    --shadow: 0 8px 30px rgba(2,6,23,.08);
    --logo-url: "https://gwtpl.co/logo.png";
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:#f4f6f8;
    color:#111;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
  }

  /* Controls */
  .top-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:14px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:none;transition:transform .15s, box-shadow .15s}
  button.secondary{background:#fff;color:var(--accent);border:1px solid #dbeafe}
  button:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(11,83,148,.12)}
  .hint{color:var(--muted);font-size:13px;margin-left:auto}

  /* Center preview container */
  .preview-wrap{display:flex;flex-direction:column;align-items:center;gap:18px}
  .paper{
    width:calc(var(--paper-w));
    max-width:100%;
    background:#fff;
    padding:18mm;          /* A4 inner padding for print */
    box-shadow:var(--shadow);
    position:relative;
    overflow:hidden;
    border:1px solid #e6eef8;
    border-radius:6px;
    transform-origin:top center;
    transition:transform .18s ease;
    animation:fadeIn .5s ease;
  }

  /* watermark */
  .watermark{
    position:absolute;
    left:50%;
    top:48%;
    transform:translate(-50%,-50%);
    opacity:.06;
    pointer-events:none;
    width:60%;
    filter:grayscale(1);
  }
  .watermark img{width:100%;height:auto;display:block}

  /* header */
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;gap:12px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo img{height:56px;width:auto;display:block}
  .title{flex:1;text-align:center}
  .title h1{margin:0;font-size:18px;letter-spacing:.6px;font-weight:700}
  .title p{margin:0;color:var(--muted);font-size:12px}
  .qr{width:86px;height:86px;background:#fbfbfd;border:1px dashed #e6eef8;display:flex;align-items:center;justify-content:center;font-size:11px;color:#475569;border-radius:6px}

  /* info row */
  .info-row{display:flex;gap:10px;align-items:center;margin:8px 0;flex-wrap:wrap}
  .chip{background:#fff;border:1px solid #eef2ff;padding:8px 10px;border-radius:6px;font-size:13px;min-width:120px;text-align:center}

  /* form grid */
  .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:12px 0}
  .field label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
  .field input, .field select, .field textarea{width:100%;padding:8px;border:1px solid #e6eef8;border-radius:6px;font-size:14px}
  .field select{background:#fff}
  textarea.auto-resize{min-height:56px;resize:none;overflow:hidden}

  /* items table */
  .items{width:100%;border-collapse:collapse;margin-top:6px}
  .items th, .items td{border:1px solid #e6eef8;padding:8px;font-size:13px}
  .items th{background:#fbfdff;text-align:left}
  .items tbody tr{transition:transform .18s,opacity .18s}
  .items tbody tr.new{animation:slideIn .22s ease}
  .small{font-size:12px;color:var(--muted)}

  .table-actions{display:flex;gap:8px;margin-top:8px;align-items:center}
  .add-row{background:linear-gradient(180deg,#e6f0ff,#d9ecff);color:var(--accent);border:1px solid #cfe0ff;padding:8px 10px;border-radius:8px;cursor:pointer}
  .remove-btn{background:#ffefef;border:1px solid #ffd2d2;color:#c91818;padding:6px 8px;border-radius:6px;cursor:pointer}

  /* totals */
  .totals{display:flex;justify-content:flex-end;margin-top:8px;gap:12px}
  .totals .box{background:#fafafa;border:1px solid #eef2ff;padding:8px 10px;border-radius:6px;font-weight:600}

  /* signature blocks (two repeated) */
  .sign-row{display:flex;gap:14px;margin-top:12px}
  .sign-block{flex:1;border:1px solid #eef2ff;padding:10px;border-radius:6px;min-height:110px;display:flex;flex-direction:column;gap:6px}
  .sign-block .label{font-size:13px;color:var(--muted)}
  .sign-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:auto}
  .sign-grid .cell{font-size:13px;min-height:36px;border-top:1px dashed #e6eef8;padding-top:6px}

  /* remarks */
  .remarks{margin-top:12px}
  .bold-note{margin-top:8px;text-align:center;font-weight:800;color:#000}

  /* responsive */
  @media (max-width:900px){
    .form-grid{grid-template-columns:1fr; }
    .sign-row{flex-direction:column}
    header{flex-direction:column;gap:8px;align-items:center}
    .qr{width:72px;height:72px}
    .logo img{height:44px}
  }

  /* print specific */
  @media print{
    body{background:transparent;margin:0}
    .preview-wrap{transform:scale(.98)}
    .paper{box-shadow:none;border:none;padding:14mm}
    /* Print two copies top-bottom on single A4: we'll duplicate the main content */
    .no-print{display:none !important}
    @page{size:A4;margin:0}
  }

  /* animations */
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  @keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

  /* small helpers */
  .muted{color:var(--muted);font-size:13px}
  .center{text-align:center}
</style>
</head>
<body>
  <div class="top-controls">
    <button id="savePrintBtn">Save & Print</button>
    <button id="previewBtn" class="secondary">Print Preview</button>
    <button id="resetBtn" class="secondary">Reset Form</button>
    <div class="hint">Advanced Gate Pass — A4 Ready • Mobile Friendly</div>
  </div>

  <div class="preview-wrap">
    <!-- PAPER (we'll duplicate inside print function for two copies) -->
    <div id="paperSingle" class="paper" role="document" aria-label="Gate Pass">
      <!-- watermark -->
      <div class="watermark" aria-hidden="true">
        <img src="https://gwtpl.co/logo.png" alt="watermark">
      </div>

      <header>
        <div class="logo">
          <img src="https://gwtpl.co/logo.png" alt="GWTPL Logo">
        </div>

        <div class="title">
          <h1>Globus Warehousing and Trading Pvt. Ltd.</h1>
          <p>Abohar</p>
        </div>

        <div class="qr" id="qrPlaceholder">QR</div>
      </header>

      <!-- gatepass info -->
      <div class="info-row">
        <div class="chip"><strong>Gate Pass No.</strong><div id="gpNo" class="small"></div></div>
        <div class="chip"><strong>Type</strong>
          <div class="small">
            <select id="gpType">
              <option>Stock Transfer Voucher</option>
              <option>Stock Transfer Returnable</option>
              <option>Transfer</option>
            </select>
          </div>
        </div>
        <div class="chip"><strong>Date</strong><div id="gpDate" class="small"></div></div>
      </div>

      <!-- consignor/consignee fields -->
      <div class="form-grid">
        <div class="field">
          <label>Consignor Unit</label>
          <input id="consignor" placeholder="Enter consignor unit">
        </div>
        <div class="field">
          <label>Person Carrying</label>
          <input id="personCarrying" placeholder="Name of person carrying">
        </div>
        <div class="field">
          <label>Vehicle No.</label>
          <input id="vehicleNo" placeholder="Vehicle registration no.">
        </div>

        <div class="field">
          <label>Consignee Unit</label>
          <input id="consignee" value="GWTPL Abohar" readonly>
        </div>
        <div class="field">
          <label>Authorised Person</label>
          <input id="authPerson" placeholder="Mr. Name">
        </div>
        <div class="field">
          <label>Outward Register Sr. No.</label>
          <input id="outwardSr" placeholder="">
        </div>
      </div>

      <!-- items table -->
      <div>
        <table class="items" id="itemsTable" aria-describedby="itemDetails">
          <thead>
            <tr>
              <th style="width:40px">Sr</th>
              <th>Item Description</th>
              <th style="width:80px">Qty</th>
              <th style="width:110px">Unit</th>
              <th style="width:110px">Tag No</th>
              <th style="width:110px">SR No</th>
              <th style="width:140px">Remarks</th>
              <th style="width:90px">Action</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>

        <div class="table-actions">
          <button class="add-row" id="addRowBtn">+ Add Item</button>
          <div class="muted" style="margin-left:auto">Tip: Use tab to quickly add items</div>
        </div>

        <div class="totals">
          <div class="box" id="subTotals">Subtotal: -</div>
        </div>
      </div>

      <!-- signatures: Issued By -->
      <div style="margin-top:18px;">
        <strong>Consignee / Issued By</strong>
        <div class="sign-row">
          <div class="sign-block">
            <div class="label">For Security</div>
            <div class="small">Outward Reg. Sr No: <input id="secOutward1" style="border:none;background:transparent;width:70%"></div>
            <div class="small">Date: <input type="date" id="secDate1"></div>
            <div class="small" style="margin-top:auto;border-top:1px dashed #eef2ff;padding-top:8px">Stamp & Sign</div>
          </div>

          <div class="sign-block">
            <div class="label">For Authorised Person</div>
            <div class="small">Name: <input id="authName1" style="border:none;background:transparent;width:70%"></div>
            <div class="small">Designation: <input id="authDesig1" style="border:none;background:transparent;width:70%"></div>
            <div class="small" style="margin-top:auto;border-top:1px dashed #eef2ff;padding-top:8px">Stamp & Sign</div>
          </div>
        </div>
      </div>

      <!-- signatures: Received By -->
      <div style="margin-top:14px;">
        <strong>Consignee / Received By</strong>
        <div class="sign-row">
          <div class="sign-block">
            <div class="label">For Security</div>
            <div class="small">Outward Reg. Sr No: <input id="secOutward2" style="border:none;background:transparent;width:70%"></div>
            <div class="small">Date: <input type="date" id="secDate2"></div>
            <div class="small" style="margin-top:auto;border-top:1px dashed #eef2ff;padding-top:8px">Stamp & Sign</div>
          </div>

          <div class="sign-block">
            <div class="label">For Authorised Person</div>
            <div class="small">Name: <input id="authName2" style="border:none;background:transparent;width:70%"></div>
            <div class="small">Designation: <input id="authDesig2" style="border:none;background:transparent;width:70%"></div>
            <div class="small" style="margin-top:auto;border-top:1px dashed #eef2ff;padding-top:8px">Stamp & Sign</div>
          </div>
        </div>
      </div>

      <!-- remarks -->
      <div class="remarks">
        <label class="small">Remarks</label>
        <textarea id="remarks" class="auto-resize" placeholder="Type remarks here..."></textarea>
        <div class="bold-note">Goods are not for sale — only site to site transfer</div>
      </div>

    </div> <!-- end of paperSingle -->
  </div>

<script>
/* -------------------------
   Configuration & helpers
   ------------------------- */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzRQnXv5VJe8Io0QSyNEddGvZazOFU_QVLdrT7tCWoP9D_0kIJKR6pXv68bs_6rMotFug/exec";
// localStorage key for fallback increment
const LS_COUNTER_KEY = "gwtpl_gp_counter_v1";

/* DOM refs */
const gpNoEl = document.getElementById('gpNo');
const gpDateEl = document.getElementById('gpDate');
const addRowBtn = document.getElementById('addRowBtn');
const itemsBody = document.getElementById('itemsBody');
const subTotalsEl = document.getElementById('subTotals');
const savePrintBtn = document.getElementById('savePrintBtn');
const previewBtn = document.getElementById('previewBtn');
const resetBtn = document.getElementById('resetBtn');
const qrPlaceholder = document.getElementById('qrPlaceholder');
const remarksEl = document.getElementById('remarks');

/* initial state */
let items = [];

/* utilities */
function formatDate(d){
  const mNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return ("0" + d.getDate()).slice(-2) + "-" + mNames[d.getMonth()] + "-" + d.getFullYear();
}
function pad(num, len=4){ return String(num).padStart(len,'0'); }

/* Gate Pass no generator - tries server first (on save). For preview uses fallback */
function generateLocalGPNo(){
  const year = new Date().getFullYear();
  let counter = Number(localStorage.getItem(LS_COUNTER_KEY) || 0) + 1;
  localStorage.setItem(LS_COUNTER_KEY, counter);
  return `GWTPL/ABO/${year}/${pad(counter,4)}`;
}

/* build preview values */
function refreshHeaderPreview(gpNo = null){
  const d = new Date();
  gpDateEl.textContent = formatDate(d);
  gpNoEl.textContent = gpNo || generateLocalPreviewNo();
  generateQR(gpNoEl.textContent);
}

/* preview-only gp no derived from localStorage but not incrementing real counter */
function generateLocalPreviewNo(){
  const year = new Date().getFullYear();
  const counter = Number(localStorage.getItem(LS_COUNTER_KEY) || 0) + 1;
  return `GWTPL/ABO/${year}/${pad(counter,4)}`;
}

/* items handling */
function renderItems(){
  itemsBody.innerHTML = '';
  items.forEach((it, idx) => {
    const tr = document.createElement('tr');
    tr.classList.add('new');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><input value="${escapeHtml(it.desc||'')}" data-i="${idx}" data-field="desc" style="width:100%;border:none"></td>
      <td><input value="${it.qty||''}" data-i="${idx}" data-field="qty" style="width:100%;border:none"></td>
      <td>
        <select data-i="${idx}" data-field="unit" style="width:100%;border:none">
          <option ${it.unit==='nos'?'selected':''}>nos</option>
          <option ${it.unit==='kg'?'selected':''}>kg</option>
          <option ${it.unit==='ltr'?'selected':''}>ltr</option>
          <option ${it.unit==='box'?'selected':''}>box</option>
          <option ${it.unit==='set'?'selected':''}>set</option>
          <option ${it.unit==='roll'?'selected':''}>roll</option>
        </select>
      </td>
      <td><input value="${escapeHtml(it.tag||'')}" data-i="${idx}" data-field="tag" style="width:100%;border:none"></td>
      <td><input value="${escapeHtml(it.sr||'')}" data-i="${idx}" data-field="sr" style="width:100%;border:none"></td>
      <td><input value="${escapeHtml(it.remark||'')}" data-i="${idx}" data-field="remark" style="width:100%;border:none"></td>
      <td><button class="remove-btn" data-i="${idx}">Remove</button></td>
    `;
    itemsBody.appendChild(tr);
  });
  attachItemListeners();
  computeSubtotals();
}

/* attach listeners for inputs and remove buttons */
function attachItemListeners(){
  // inputs/selects
  itemsBody.querySelectorAll('input,select').forEach(el=>{
    el.addEventListener('input', (e)=>{
      const idx = Number(el.dataset.i);
      const field = el.dataset.field;
      let val = el.value;
      if(field==='qty'){ val = val.replace(/[^\d.\-]/g,''); } // basic clean
      items[idx][field] = val;
      computeSubtotals();
    });
  });
  // remove btns
  itemsBody.querySelectorAll('.remove-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      const idx = Number(b.dataset.i);
      items.splice(idx,1);
      renderItems();
    });
  });
}

/* compute subtotal per unit */
function computeSubtotals(){
  const map = {};
  items.forEach(it=>{
    const unit = it.unit || 'nos';
    const qty = Number(it.qty) || 0;
    map[unit] = (map[unit] || 0) + qty;
  });
  const parts = Object.keys(map).map(u => `${u}: ${map[u]}`).join(' | ');
  subTotalsEl.textContent = parts || 'Subtotal: -';
}

/* escape helper for input insertion into value attr */
function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* auto-resize remarks */
function autoResizeTextarea(){
  remarksEl.style.height = 'auto';
  remarksEl.style.height = (remarksEl.scrollHeight) + 'px';
}
remarksEl.addEventListener('input', autoResizeTextarea);

/* add row */
addRowBtn.addEventListener('click', ()=>{
  items.push({desc:'', qty:'', unit:'nos', tag:'', sr:'', remark:''});
  renderItems();
});

/* reset form */
resetBtn.addEventListener('click', ()=>{
  if(!confirm('Reset form and clear items?')) return;
  items = [];
  renderItems();
  document.querySelectorAll('input[type=text], input[type=date]').forEach(i=>i.value='');
  document.getElementById('authPerson').value='';
  document.getElementById('consignor').value='';
  remarksEl.value='';
  autoResizeTextarea();
  refreshHeaderPreview();
});

/* basic QR generation - using simple canvas method (no external lib) */
function generateQR(text){
  // We'll use a very small QR library created inline (minimal)
  try{
    // Use built-in browser API? No. So use a lightweight implementation: use Google Chart API fallback (online)
    // But to keep it self-contained, we'll use a simple data URL from QR code via chart.googleapis (works offline? requires network).
    // We'll prefer a client-side lib if available; fallback to google chart.
    const encoded = encodeURIComponent(text);
    const url = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encoded}&chld=L|0`;
    qrPlaceholder.innerHTML = `<img src="${url}" alt="QR" style="width:100%;height:100%;object-fit:contain">`;
  }catch(e){
    qrPlaceholder.textContent = 'QR';
  }
}

/* initial render */
(function init(){
  refreshHeaderPreview();
  items = [{desc:'', qty:'', unit:'nos', tag:'', sr:'', remark:''}];
  renderItems();
  autoResizeTextarea();
})();

/* collect form data */
function collectFormData(){
  const data = {
    gate_pass_no: gpNoEl.textContent || generateLocalPreviewNo(),
    type: document.getElementById('gpType').value,
    date: gpDateEl.textContent,
    consignor: document.getElementById('consignor').value || '',
    person_carrying: document.getElementById('personCarrying').value || '',
    vehicle_no: document.getElementById('vehicleNo').value || '',
    consignee: document.getElementById('consignee').value || 'GWTPL Abohar',
    authorised_person: document.getElementById('authPerson').value || '',
    outward_sr: document.getElementById('outwardSr').value || '',
    items: items.map(it => ({desc: it.desc||'', qty: it.qty||0, unit: it.unit||'nos', tag: it.tag||'', sr: it.sr||'', remark: it.remark||''})),
    remarks: remarksEl.value || '',
    created_at: new Date().toISOString()
  };
  return data;
}

/* save to Google Script */
async function saveToGoogleSheet(payload){
  try{
    const resp = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload),
      mode: 'cors'
    });
    if(!resp.ok) throw new Error('Network response was not ok');
    const json = await resp.json();
    return json; // expect server to return { success:true, gate_pass_no: 'GWTPL/ABO/2025/0001', ... }
  }catch(err){
    console.warn('Save failed (will fallback to local):', err);
    return { success:false, error:err.message };
  }
}

/* main save & print flow */
savePrintBtn.addEventListener('click', async ()=>{
  savePrintBtn.disabled = true;
  savePrintBtn.textContent = 'Saving...';
  const payload = collectFormData();

  // Attempt to save to Google Sheet endpoint
  const res = await saveToGoogleSheet(payload);
  if(res && res.success && res.gate_pass_no){
    // server provided canonical gatepass number
    gpNoEl.textContent = res.gate_pass_no;
    // optionally update local counter to server counter if provided (not implemented)
  } else {
    // fallback: generate local and persist counter
    const localGP = generateLocalGPNo();
    gpNoEl.textContent = localGP;
  }
  // regenerate QR with final gp no
  generateQR(gpNoEl.textContent);

  // small delay for rendering
  setTimeout(()=> {
    // Print two copies top-bottom
    // We'll open a new window with duplicated content for consistent print output
    const content = document.getElementById('paperSingle').outerHTML;
    const wrapper = `
      <html><head>
      <title>Gate Pass - ${gpNoEl.textContent}</title>
      <style>
        @page{size:A4;margin:0}
        body{margin:0;padding:0;font-family:Inter,Arial; -webkit-print-color-adjust: exact;}
        .paper{width:210mm;box-sizing:border-box;padding:14mm;border:1px solid #e6eef8}
        .watermark{opacity:.06}
      </style>
      </head><body>
        ${content}
        <div style="height:12mm"></div>
        ${content}
      </body></html>
    `;
    const w = window.open('', '_blank');
    w.document.open();
    w.document.write(wrapper);
    w.document.close();
    // allow time to load images
    setTimeout(()=> {
      w.focus();
      w.print();
      // optionally close window after print:
      // w.close();
    }, 800);
    savePrintBtn.disabled = false;
    savePrintBtn.textContent = 'Save & Print';
  }, 300);
});

/* preview only */
previewBtn.addEventListener('click', ()=>{
  // Duplicate content and open print preview without saving
  const content = document.getElementById('paperSingle').outerHTML;
  const wrapper = `
    <html><head>
      <title>Gate Pass Preview</title>
      <style>
        @page{size:A4;margin:0}
        body{margin:0;font-family:Inter,Arial}
        .paper{width:210mm;box-sizing:border-box;padding:14mm;border:1px solid #e6eef8}
        .watermark{opacity:.06}
      </style>
    </head><body>
      ${content}
      <div style="height:12mm"></div>
      ${content}
    </body></html>
  `;
  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(wrapper);
  w.document.close();
});

/* helper: simple escape (already defined earlier) */
/* auto-generate gpNo preview on load */
refreshHeaderPreview();

/* small accessibility: keyboard shortcut to add row (Ctrl+Enter) */
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key==='Enter'){ addRowBtn.click(); }
});

</script>
</body>
</html>
